# PHP/TYPO3 Development Standards

## Code Style
- Respect PSR-12 for all PHP files
- Use the existing .editorconfig for indentation and formatting
- Follow the style of existing files in the project
- Use exclusively single quotes (`'`) for strings in PHP
- Pay attention to type safety
- Prefer `$variable === false` instead of `!$variable`
- Avoid early returns in PHP functions
- Avoid global exceptions (e.g., RuntimeException) and implement custom exceptions
- Global catch blocks should listen to `\Throwable` and not to `\Exception`
- Use constants for central values (e.g., limits, constant values in the database, etc.)
- Use enums when appropriate
- Avoid fully qualified names (FQN) where possible
- Always use `declare(strict_types=1);` after `<?php`
- Config files: use `defined('TYPO3') || die();` instead of `defined('TYPO3') or die();` in `ext_tables.php` and `ext_localconf.php`

## Code Quality & Clean Code
- Avoid code smells such as:
    - Long Methods (> 20-30 lines)
    - Large Classes (> 300 lines)
    - Duplicate Code
    - Too Many Parameters (> 3-4)
    - Deep Nesting (> 3 levels)
    - Magic Numbers and Strings
- Prefer descriptive variable and method names
- Follow Single Responsibility Principle
- DRY Principle: Extract repeated code into methods/services
- Reduce complexity: Use early returns instead of nested if-blocks
- Avoid inline comments and use readable function and variable names instead

## TYPO3 Specific
- Follow TYPO3 Coding Guidelines (for PHP see https://docs.typo3.org/m/typo3/reference-coreapi/main/en-us/CodingGuidelines/CglPhp/GeneralRequirementsForPhpFiles.html#general-requirements-for-php-files)
- Reference the code of TYPO3 packages for style and format
- Use modern Extbase/Fluid patterns
- Use Doctrine DBAL instead of deprecated DB queries
- Follow the principle of a slim controller
- Use `RequestFactory` instead of `GeneralUtility::getUrl()` or `curl_setopt()` (see https://docs.typo3.org/m/typo3/reference-coreapi/main/en-us/ExtensionArchitecture/HowTo/RestRequests/Index.html)
- Avoid using `$GLOBALS['TSFE']`
- PHP logic should always be centralized in the `Classes/Domain/` directory (or subdirectories)
- Prefer Dependency Injection via `__construct()`
- Use `defined('TYPO3') || die();` instead of `defined('TYPO3') or die();` in `ext_tables.php` and `ext_localconf.php`
- Avoid defining table fields in `ext_tables.sql` if defined in TCA, as these are automatically generated by TYPO3 (unless SQL index is needed)
- Use `GeneralUtility::cmpIP()` for IP ranges instead of unnecessary PHP packages from packagist.org

## TYPO3 Anti-Patterns (avoid!)
- Business logic in templates (Fluid)
- Direct access to `$_GET`, `$_POST`, `$_SESSION`
- Static utility calls where DI is possible
- SQL queries outside of repositories
- Suppressed errors with `@`
- Boolean functions should always be described positively, even when checking for the negative result: `isRecordExisting() === false`

## Best Practices
- Write meaningful commit messages (Conventional Commits) and follow the style of existing commit messages
- Document complex logic inline
- No hardcoded strings - use XLIFF
- Unit tests for new business logic
- Use existing TYPO3 functions or PHP packages when possible
- Use ready-made PHP packages from packagist.org in composer.json when larger functions are already available there
- Write automated tests for new features if similar tests already exist

## Workflow
- Check existing code patterns before new implementations
- Ask about architectural decisions before writing code
- Prefer refactoring over feature additions
- Point out existing code smells when you discover them while working
- If no `README.md` exists in a project, check for `readme.md`
- Documentation is usually located under `Documentation/` or `docs/`

## Namespacing
- Format: `Vendor\ExtensionKey\ComponentType\`
- Vendor name in StudlyCase
- Extension key in StudlyCase (even with underscores)

## Dependency Injection
- ALWAYS use constructor injection with `private readonly`
- NEVER use ObjectManager (removed in v12)
- NEVER use GeneralUtility::makeInstance() for services
- Services are auto-wired via Services.yaml

## Database Queries
- ALWAYS use Doctrine DBAL QueryBuilder
- ALWAYS use createNamedParameter() with PDO types
- NEVER use $GLOBALS['TYPO3_DB'] (removed in v10)
- NEVER concatenate user input into SQL

## Controllers
- Keep controllers SLIM - move business logic to services
- All actions MUST return ResponseInterface
- NEVER use $GLOBALS['TSFE'] - use request attributes
- NEVER access $_GET, $_POST, $_SESSION directly
- Use $this->request instead

## Fluid Templates
- NO business logic in templates - only presentation
- Use ViewHelpers for complex presentation logic
- NEVER use f:format.raw() on user input (XSS!)
- Prepare data in Controller/Service, not in template

## HTTP Requests
- Use RequestFactory instead of GeneralUtility::getUrl()
- Use RequestFactory instead of raw cURL

## Events
- Use PSR-14 Events instead of old hook system
- Register listeners in Services.yaml

## TCA Configuration
- Start with `defined('TYPO3') || die();`
- Return array (not $GLOBALS['TCA'][...] = [...])
- Include ctrl section with label, tstamp, crdate, delete
- Add language support fields (sys_language_uid, l10n_parent)
- Include enablecolumns (hidden, starttime, endtime)
- Don't define table fields in ext_tables.sql if already in TCA (unless SQL indexes are needed)

## Security
- Validate all user input
- QueryBuilder with named parameters (never concatenate SQL)
- Fluid escapes by default - be careful with f:format.raw()
- Validate file uploads (type, size, content)
- Never log passwords or tokens
